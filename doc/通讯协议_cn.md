# 2 通信协议

本通信协议主要供脱离可视化工具进行二次开发的用户使用。LD2450 通过串口（TTL 电平）与外界通信。雷达的数据输出与参数配置命令均在本协议下进行。雷达串口默认波特率为 256000，1 停止位，无奇偶校验位。

## 2.1 协议格式

### 2.1.1 协议数据格式

LD2450 的串口数据通信使用小端格式，以下表格中所有数据均为十六进制。

### 2.1.2 命令协议帧格式

协议定义的雷达配置命令和 ACK 命令格式如下：

#### 表 2 发送命令协议帧格式

| 帧头        | 帧内数据长度 | 帧内数据 | 帧尾        |
| ----------- | ------------ | -------- | ----------- |
| FD FC FB FA | 2 字节       | 见表 3   | 04 03 02 01 |

#### 表 3 发送帧内数据格式

| 内容            | 说明            |
| --------------- | --------------- |
| 命令字（2字节） | 命令值（N字节） |

#### 表 4 ACK 命令协议帧格式

| 帧头        | 帧内数据长度 | 帧内数据 | 帧尾        |
| ----------- | ------------ | -------- | ----------- |
| FD FC FB FA | 2 字节       | 见表 5   | 04 03 02 01 |

#### 表 5 ACK 帧内数据格式

| 内容       | 说明            |
| ---------- | --------------- |
| 发送命令字 | 0x0100（2字节） |
| 返回值     | 返回值（N字节） |

## 2.2 发送命令与 ACK

### 2.2.1 使能配置命令

对雷达下发的任何其他命令必须在此命令下发后方可执行，否则无效。

- **命令字**: `0x00FF`  
- **命令值**: `0x0001`  
- **返回值**: 2 字节 ACK 状态（0 成功，1 失败） + 2 字节协议版本（0x0001） + 2 字节缓冲区大小（0x0040）

**发送数据**:  
```
FD FC FB FA 04 00 FF 00 01 00 04 03 02 01
```

**雷达 ACK (成功)**:  
```
FD FC FB FA 08 00 FF 01 00 00 01 00 40 00 04 03 02 01
```

### 2.2.2 结束配置命令

结束配置命令，执行后雷达恢复工作模式。如需再次下发其他命令，需要先发送使能配置命令。

- **命令字**: `0x00FE`  
- **命令值**: 无  
- **返回值**: 2 字节 ACK 状态（0 成功，1 失败）

**发送数据**:  
```
FD FC FB FA 02 00 FE 00 04 03 02 01
```

**雷达 ACK (成功)**:  
```
FD FC FB FA 04 00 FE 01 00 00 04 03 02 01
```

### 2.2.3 单目标追踪

设置为单目标追踪。

- **命令字**: `0x0080`  
- **命令值**: 无  
- **返回值**: 2 字节 ACK 状态（0 成功，1 失败）

**发送数据**:  
```
FD FC FB FA 02 00 80 00 04 03 02 01
```

**雷达 ACK (成功)**:  
```
FD FC FB FA 04 00 80 01 00 00 04 03 02 01
```

### 2.2.4 多目标追踪

设置为多目标追踪。

- **命令字**: `0x0090`  
- **命令值**: 无  
- **返回值**: 2 字节 ACK 状态（0 成功，1 失败）

**发送数据**:  
```
FD FC FB FA 02 00 90 00 04 03 02 01
```

**雷达 ACK (成功)**:  
```
FD FC FB FA 04 00 90 01 00 00 04 03 02 01
```

### 2.2.5 查询目标追踪模式

查询模块当前的目标追踪，默认值为多目标追踪。

- **命令字**: `0x0091`  
- **命令值**: 无  
- **返回值**: 2 字节 ACK 状态（0 成功，1 失败） + 2 字节追踪模式值（0x0001 单目标追踪，0x0002 多目标追踪）

**发送数据**:  
```
FD FC FB FA 02 00 91 00 04 03 02 01
```

**雷达 ACK (成功)**:

返回值 `0x0001` 代表当前为单目标追踪模式  
```
FD FC FB FA 06 00 91 01 00 00 01 00 04 03 02 01
```

返回值 `0x0002` 代表当前为多目标追踪模式  
```
FD FC FB FA 06 00 91 01 00 00 02 00 04 03 02 01
```

### 2.2.6 读取固件版本命令

此命令读取雷达固件版本信息。

- **命令字**: `0x00A0`  
- **命令值**: 无  
- **返回值**: 2 字节 ACK 状态（0 成功，1 失败） + 2 字节固件类型（0x0000） + 2 字节主版本号 + 4 字节次版本号

**发送数据**:  
```
FD FC FB FA 02 00 A0 00 04 03 02 01
```

**雷达 ACK (成功)**:  
```
FD FC FB FA 0C 00 A0 01 00 00 00 00 02 01 16 24 06 22 04 03 02 01
```

对应的版本号为：V1.02.22062416

### 2.2.7 设置串口波特率

此命令用来设置模块串口的波特率，配置值掉电不丢失，配置值在重启模块后生效。

- **命令字**: `0x00A1`  
- **命令值**: 2 字节波特率选择索引  
- **返回值**: 2 字节 ACK 状态（0 成功，1 失败）

#### 表 6 串口波特率选择

| 波特率选择索引值 | 波特率 |
| ---------------- | ------ |
| 0x0001           | 9600   |
| 0x0002           | 19200  |
| 0x0003           | 38400  |
| 0x0004           | 57600  |
| 0x0005           | 115200 |
| 0x0006           | 230400 |
| 0x0007           | 256000 |
| 0x0008           | 460800 |

出厂默认值为 `0x0007`，即 256000。

**发送数据**:  
```
FD FC FB FA 04 00 A1 00 07 00 04 03 02 01
```

**雷达 ACK (成功)**:  
```
FD FC FB FA 04 00 A1 01 00 00 04 03 02 01
```

### 2.2.8 恢复出厂设置

此命令用来将所有配置值恢复为出厂值，配置值在重启模块后生效。

- **命令字**: `0x00A2`  
- **命令值**: 无  
- **返回值**: 2 字节 ACK 状态（0 成功，1 失败）

**发送数据**:  
```
FD FC FB FA 02 00 A2 00 04 03 02 01
```

**雷达 ACK (成功)**:  
```
FD FC FB FA 04 00 A2 01 00 00 04 03 02 01
```

出厂默认配置值如下：

#### 表 7 出厂默认配置值

| 配置项       | 默认值     |
| ------------ | ---------- |
| 串口波特率   | 256000     |
| 蓝牙开关     | 开         |
| 追踪模式     | 多目标追踪 |
| 区域过滤功能 | 关闭       |

### 2.2.9 重启模块

模块收到此命令，将会在应答发送完成后自动重启。

- **命令字**: `0x00A3`  
- **命令值**: 无  
- **返回值**: 2 字节 ACK 状态（0 成功，1 失败）

**发送数据**:  
```
FD FC FB FA 02 00 A3 00 04 03 02 01
```

**雷达 ACK (成功)**:  
```
FD FC FB FA 04 00 A3 01 00 00 04 03 02 01
```

### 2.2.10 蓝牙设置

此命令用于控制蓝牙的开启或关闭，模块的蓝牙功能默认为开启。配置值掉电不丢失，配置值在重启模块后生效。

- **命令字**: `0x00A4`  
- **命令值**:  
  - `0x0100` 打开蓝牙  
  - `0x0000` 关闭蓝牙  
- **返回值**: 2 字节 ACK 状态（0 成功，1 失败）

**发送数据**:  
```
FD FC FB FA 04 00 A4 00 01 00 04 03 02 01
```

表示打开蓝牙。

**雷达 ACK (成功)**:  
```
FD FC FB FA 04 00 A4 01 00 00 04 03 02 01
```

### 2.2.11 获取 MAC 地址

此命令用于查询 MAC 地址。

- **命令字**: `0x00A5`  
- **命令值**: `0x0001`  
- **返回值**: 2 字节 ACK 状态（0 成功，1 失败） + 1 字节固定类型（0x00） + 3 字节 MAC 地址（大端序）

**发送数据**:  
```
FD FC FB FA 04 00 A5 00 01 00 04 03 02 01
```

**雷达 ACK (成功)**:  
```
FD FC FB FA 0A 00 A5 01 00 00 8F 27 2E B8 0F 65 04 03 02 01
```

查询到的 MAC 地址是：`8F 27 2E B8 0F 65`

### 2.2.12 查询当前的区域过滤配置

此命令用于查询模块当前的区域过滤配置。

- **命令字**: `0x00C1`  
- **命令值**: 无  
- **返回值**: 2 字节 ACK 状态（0 成功，1 失败） + 2 字节区域过滤类型 + 24 字节区域坐标配置

**说明**:  
- **区域过滤类型**  
  - 0：关闭区域过滤功能  
  - 1：仅检测设置的区域  
  - 2：不检测设置的区域  

- **区域坐标设置**:  
  - 采用 signed int16 类型  
  - 每个区域使用矩形区域的两个对角顶点坐标（x、y），单位 mm  
  - 坐标值全为 0 表示该区域未使用  

**发送数据**:  
```
FD FC FB FA 02 00 C1 00 04 03 02 01
```

**雷达 ACK (成功)**:  
```
FD FC FB FA 1E 00 C1 01 00 00 01 00 E803 E803 18FC 8813 0000 0000 0000 0000 0000 0000 0000 0000 04 03 02 01
```

该返回数据代表当前的配置内容为：仅检测由对角顶点坐标 `(1000,1000)` 和 `(-1000,5000)` 划定的矩形区域中的目标。

### 2.2.13 设置区域过滤配置

此命令用于设置模块的区域过滤配置，配置值掉电不丢失，设置后立即生效。

- **命令字**: `0x00C2`  
- **命令值**: 26 个字节的区域过滤配置值，值格式见 **表 8 区域过滤配置值格式**  
- **返回值**: 2 字节 ACK 状态（0 成功，1 失败）

**发送数据**:  
```
FD FC FB FA 1C 00 C2 00 02 00 E803 E803 18FC 8813 0000 0000 0000 0000 0000 0000 0000 0000 04 03 02 01
```

代表设置为：不检测由对角顶点坐标 `(1000,1000)` 和 `(-1000,5000)` 划定的矩形区域中的目标。

**雷达 ACK (成功)**:  
```
FD FC FB FA 04 00 C2 01 00 00 04 03 02 01
```

## 2.3 雷达数据输出协议

LD2450 模组通过串口与外界通信，输出检测到的目标信息，包括区域中的 x 坐标、y 坐标，以及目标的速度值。 

雷达串口默认波特率为 256000，1 停止位，无奇偶校验位。

雷达上报的数据格式如下，每秒上报 10 帧。

#### 表 9 上报数据帧格式

| 帧头部      | 帧内数据                            | 帧尾部 |
| ----------- | ----------------------------------- | ------ |
| AA FF 03 00 | 目标1信息<br>目标2信息<br>目标3信息 | 55 CC  |

其中单个目标具体包含的信息如下（单位及数据类型说明）：

- **目标 X 坐标**: signed int16 类型，最高位 1 对应正坐标，0 对应负坐标，单位 mm  
- **目标 Y 坐标**: signed int16 类型，最高位 1 对应正坐标，0 对应负坐标，单位 mm  
- **目标速度**: signed int16 类型，最高位 1 对应正向速度，0 对应负向速度，其余 15 位表示速度，单位 cm/s  
- **距离分辨率**: uint16 类型，表示单个距离门大小，单位 mm  

#### 表 10 帧内数据格式

**数据示例**:

```
AA FF 03 00 0E 03 B1 86 10 00 40 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 55 CC
```

该组数据表示雷达当前跟踪到一个目标（目标1，示例中蓝色字段），目标2 和目标3（分别对应示例中的红色和黑色字段）不存在，故其相应数据段为 `0x00`。

数据转换示例：

- **目标1 X 坐标**:  
  计算方式：0x0E + 0x03 * 256 = 782  
  实际值：0 - 782 = -782 mm

- **目标1 Y 坐标**:  
  计算方式：0xB1 + 0x86 * 256 = 34481  
  实际值：34481 - 2^15 = 1713 mm

- **目标1 速度**:  
  计算方式：0x10 + 0x00 * 256 = 16  
  实际值：0 - 16 = -16 cm/s

- **目标1 距离分辨率**:  
  计算方式：0x40 + 0x01 * 256 = 320 mm

---

## 2.4 雷达命令配置方式

LD2450 雷达执行一条配置命令的过程包含上位机“发送命令”与雷达“回复命令 ACK”两个环节。若雷达无 ACK 回复或回复 ACK 失败，则说明雷达执行配置命令失败。

如前所述，向雷达发送任何其他命令前，开发者需先发送“使能配置”命令，然后在规定时间内发送配置命令。命令配置完成之后，再发送“结束配置”命令告知雷达配置已经结束。

例如，若要读取雷达配置参数，流程为：  
1. 上位机发送“使能配置”命令；  
2. 待收到雷达 ACK 成功后，发送“读取参数”命令；  
3. 待收到雷达 ACK 成功后，发送“结束配置”命令；  
4. 待雷达 ACK 成功后，表示完整的读取参数动作结束。

---

